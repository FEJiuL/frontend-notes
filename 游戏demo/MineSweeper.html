<!DOCTYPE html>
<html>
<head>
	<title>扫雷游戏</title>
	<style type="text/css">
		.map{
			width: 900px;
			height: 480px;
			margin: 120px auto;
			outline: 1px solid #ccc;
		    display: flex;
		    flex-wrap: wrap;
		    justify-content: flex-start;
		}
		.box{
			width: 30px;
			height: 30px;
			position: relative;;
			background-color: #2196f3;
			outline: 1px solid #ccc;
			color: #fff;
			text-align: center;
			line-height: 30px;
		}
		.box[type="0"]{
			background-color: #fff;
			color: #666
		}
		.box[type="x"]{
			background-color: #f44336;
			color: #fff;
		}
		.box[type="1"],
		.box[type="2"],
		.box[type="3"],
		.box[type="4"],
		.box[type="5"],
		.box[type="6"],
		.box[type="7"],
		.box[type="8"]{
			background-color: #2196f3;
			color: #fff;
		}
		.box[type="x"]:before,
		.box[type="1"]:before,
		.box[type="2"]:before,
		.box[type="3"]:before,
		.box[type="4"]:before,
		.box[type="5"]:before,
		.box[type="6"]:before,
		.box[type="7"]:before,
		.box[type="8"]:before{
			content: attr(type);
		}
		.box[id]{
			background-color: #9e9e9e;
			color: #9e9e9e;
		}
		.box[sign]{
			background-color: #f44336;
			color: #f44336;
		}
		.op-wrap{
			width: 600px;
			margin: 0 auto;
			text-align: center;
		}
	</style>
</head>
<body>
<div class="map" id="map"></div>
<div class="op-wrap">
	<button id="btn">开始游戏</button>
</div>
<script type="text/javascript">

	let width = 30;  //图宽
	let height = 16; //图高
	let landmine = 90; //雷数
	let num = 0;  //已排雷数
	let $map = document.getElementById("map");
	let $btn = document.getElementById("btn");

	const clickHandle = (e) => {
		let target = e.target;
		let className = target.getAttribute('class');
		let sign = target.getAttribute('sign');
		let id = target.getAttribute('id');
		if(className == 'box' && id && !sign){
			let [x, y] = id.split('_')[1].split('-');
			click(+x, +y)  //注意数据类型（坑）
		}
	}

	const rightClickHandle = (e) => {
		if(e.button == 2){ //表示右击
			let target = e.target;
			let className = target.getAttribute('class');
			let id = target.getAttribute('id');
			if(className == 'box' && id){
				let type = target.getAttribute('type');
				let sign = target.getAttribute('sign');
				num += type == 'x' ? (sign ? -1 : +1) : 0;
				sign ? target.removeAttribute('sign') :
					target.setAttribute('sign', '1');
			}
		}	
	}

	$map.oncontextmenu = (e) => e.preventDefault(); //禁用右键菜单
	$btn.onclick = () => main();

	const randomNum = (start, end) => {
		let rg = end - start;
		return Math.floor(Math.random() * rg) + start;
	}

	//随机生成雷区
	const generateLandMine = (len, map, w, h) => {
		let cache = new Set(); //去重
		for(let i = 0; i < len; i++){
			let x = randomNum(0, w);
			let y = randomNum(0, h);
			cache.add(`${x}${y}`);
			if(cache.size == i + 1){
				map[y][x] = 'x';
			} else {
				i -= 1;
			}
		}
		return map;
	}

	//扫描当前位置8个方向
	const scanAround = (map, x, y) => {
		let sum = 0;
		//上/左上/右上
		if(x - 1 >= 0){
			if(map[x - 1][y] == 'x')
				sum += 1
			if(y - 1 >= 0 && map[x - 1][y - 1] == 'x')
				sum += 1;
			if(y + 1 < width && map[x - 1][y + 1] == 'x')
				sum += 1;
		}
		//下/左下/右下
		if(x + 1 < height){
			if(map[x + 1][y] == 'x')
				sum += 1
			if(y - 1 >= 0 && map[x + 1][y - 1] == 'x')
				sum += 1;
			if(y + 1 < width && map[x + 1][y + 1] == 'x')
				sum += 1;
		}
		//右
		if(y + 1 < width && map[x][y + 1] == 'x')
			sum += 1;
		//左
		if(y - 1 >= 0 && map[x][y - 1] == 'x')
			sum += 1;
		map[x][y] = sum;
	}

	//生成扫雷地图
	const generateGameMap = (w, h) => {
		let map = [];
		for(let i = 0; i < h; i++){
			let row = new Array(w).fill(0)
			map.push(row);
		}
		map = generateLandMine(landmine, map, w, h);  //添加雷区
		for(let x = 0; x < h; x++){
			for(let y = 0; y < w; y++){
				if(map[x][y] !== 'x')
					scanAround(map, x, y);
			}
		}
		return map;
	}


	const main = () => {
		let map = generateGameMap(width, height);
		$map.innerHTML = render(map);
		num = 0;
		//绑定点击事件
		$map.addEventListener('click', clickHandle);
		$map.onmouseup = (e) => rightClickHandle(e)
	}

	const render = (map) => {
		let html = '';
		for(let i = 0; i < height; i++){
			for(let j = 0; j < width; j++){
				html += `<div class="box" id="box_${i}-${j}" type="${map[i][j]}"></div>`
			}
		}
		return html;
	}

	const getNode = (x, y) => {
		let id = `box_${x}-${y}`;
		return document.getElementById(id);
	}

	//扫描当前位置8个方向是否可打开
	const scanAroundClick = (x, y) => {
		//上/左上/右上
		if(x - 1 >= 0){
			if(getNode(x - 1, y))
				click(x - 1, y)		
			if(y - 1 >= 0 && getNode(x - 1, y - 1))
				click(x - 1, y - 1)
			if(y + 1 < width && getNode(x - 1, y + 1))
				click(x - 1, y + 1)
		}
		//下/左下/右下
		if(x + 1 < height){
			if(getNode(x + 1, y))
				click(x + 1, y)
			if(y - 1 >= 0 && getNode(x + 1, y - 1))
				click(x + 1, y - 1)
			if(y + 1 < width && getNode(x + 1, y + 1))
				click(x + 1, y + 1)
		}
		//右
		if(y + 1 < width && getNode(x, y + 1))
			click(x, y + 1)	
		//左
		if(y - 1 >= 0 && getNode(x, y - 1))
			click(x, y - 1)	
	}

	const click = (x, y) => {
		let $node = getNode(x, y)
		if($node){
			$node.removeAttribute('id');
			let type = $node.getAttribute('type');
			if(type == '0')
				scanAroundClick(x, y);
			else if(type == 'x'){
				$map.removeEventListener('click', clickHandle);
				$map.onmouseup = null;
				setTimeout(() => alert('游戏结束'), 15);
			}
		}
	}

	const test = (x, y) => {
		x = isNaN(x) ? randomNum(0, height) : x;
		y = isNaN(y) ? randomNum(0, width) : y;
		click(x, y)
	}
</script>
</body>
</html>
